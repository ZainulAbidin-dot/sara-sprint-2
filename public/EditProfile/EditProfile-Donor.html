<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />

    <link rel="stylesheet" href="../EditProfile/EditProfile.css" />
    <link rel="stylesheet" href="../PostHeader/PostHeader.css" />
  </head>

  <body>
    <header class="header">
      <div class="header-logo"><span>T</span>ADAWI</div>
      <nav class="nav">
        <a href="../Home/HomePage.html">Home</a>
        <a href="../About-us/About-usPostDonor.html">About us</a>
        <a href="../DonationsPgae/DonationsPage.html">Donations</a>
        <a href="../HelpPage/Help-Donor.html">Help</a>
        <a href="../NotificationsPage/Donor-NotifPage.html">Notifications</a>
      </nav>
      <div class="buttons-container">
        <img src="" id="" />
        <a href="../Home/HomePage.html">
          <button id="signout-btn">Sign Out</button></a
        >
        <a href="../EditProfile/EditProfile-Donor.html">
          <button id="edit-btn">Edit Profile</button></a
        >
      </div>
    </header>

    <form id="edit-profile-form">
      <div>
        <div class="container">
          <div class="header-second">
            <a href="../Home/HomePage-Donor.html" class="back">‚Üê Back</a>
            <h2>Edit Donor Profile</h2>

            <label for="email">Email</label>
            <input
              type="email"
              id="email"
              placeholder="Please Enter a valid email"
              required=""
            />

            <label for="password">Password</label>
            <input
              type="password"
              id="password"
              placeholder="Please use a strong password"
              required=""
            />
            <span class="error" id="error-message"></span>

            <label for="confirm-password">Confirm Password</label>
            <input
              type="password"
              id="confirm-password"
              placeholder="Please re-enter your password"
              required=""
            />

            <label for="full-name">Full Name</label>
            <input
              type="text"
              id="full-name"
              placeholder="Enter your full name"
              required=""
            />

            <label for="title">Title</label>
            <select id="title" name="title">
              <option value="" disabled="" selected="">Select</option>
              <option value="Mr.">Mr.</option>
              <option value="Mrs.">Mrs.</option>
              <option value="Ms.">Ms.</option>
              <option value="Miss">Miss</option>
              <option value="Dr.">Dr.</option>
              <option value="Prof.">Prof.</option>
            </select>

            <label for="Role">Role</label>
            <select id="Role" required="">
              <option value="" disabled selected>Select your user role</option>
              <option value="donor">Donor</option>
              <option value="acquirer">Acquirer</option>
              <option value="both">Both</option>
            </select>

            <label for="phone">Phone Number</label>
            <input type="tel" id="phone" placeholder="+966" required="" />

            <label for="dob">Date of Birth</label>
            <input type="date" id="dob" required="" />

            <label for="gender">Gender</label>
            <select id="gender" required="">
              <option value="" disabled="" selected="">
                Select your gender
              </option>
              <option value="male">Male</option>
              <option value="female">Female</option>
            </select>

            <div>
              <label for="region">Region</label>
              <select id="region" name="region">
                <option value="" disabled="" selected="">
                  Select current region
                </option>
                <option value="region1">Abha</option>
                <option value="region2">Al Bahah</option>
                <option value="region3">Sakaka</option>
                <option value="region4">Buraidah</option>
                <option value="region5">Dammam</option>
                <option value="region6">Jazan</option>
                <option value="region7">Makkah</option>
                <option value="region8">Madinah</option>
                <option value="region9">Najran</option>
                <option value="region10">Arar</option>
                <option value="region11">Riyadh</option>
                <option value="region12">Tabuk</option>
                2
                <option value="region13">Hail</option>
              </select>
            </div>

            <label for="nationality">Nationality</label>
            <select id="nationality" required="">
              <option value="" disabled="" selected="">
                Select your nationality
              </option>
              <option value="saudi">Saudi</option>
              <option value="other">Other</option>
            </select>

            <div>
              <button type="submit">Confirm</button>
            </div>
          </div>
        </div>
      </div>
    </form>
  </body>
  <script>
    document
      .getElementById('signout-btn')
      .addEventListener('click', function () {
        alert('You have signed out!');
        window.location.href = '../Home/HomePage.html'; // Redirect to home page, same effect as the signout redirect in html in header
      });

    document.getElementById('edit-btn').addEventListener('click', function () {
      alert('Edit button clicked!');
      window.location.href = '../EditProfile/EditProfile-Donor.html'; //same effect as the edit button redirect in html in header
    });

    document.addEventListener('DOMContentLoaded', () => {
      const form = document.querySelector('form');
      const emailInput = document.getElementById('email');
      const passwordInput = document.getElementById('newpass');
      const confirmPasswordInput = document.getElementById('confpass');
      const fullnameInput = document.getElementById('fullname');
      const titleSelect = document.getElementById('title');
      const phoneInput = document.getElementById('phonenum');
      const nationalitySelect = document.getElementById('nationality');
      const birthInput = document.getElementById('birth');

      // Add a small message element for password feedback
      const passwordMessage = document.createElement('small');
      passwordMessage.style.color = 'red';
      passwordInput.parentNode.appendChild(passwordMessage);

      // Function to check password strength
      const isStrongPassword = (password) => {
        const strongPasswordPattern =
          /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;
        return strongPasswordPattern.test(password);
      };

      // Email validation
      emailInput.addEventListener('input', () => {
        if (!emailInput.validity.valid) {
          emailInput.setCustomValidity('Please enter a valid email address.');
        } else {
          emailInput.setCustomValidity('');
        }
      });

      // Password strength validation
      passwordInput.addEventListener('input', () => {
        if (!isStrongPassword(passwordInput.value)) {
          passwordInput.style.borderColor = 'red';
          passwordMessage.textContent =
            'Password must be at least 8 characters long, include uppercase and lowercase letters, a number, and a special character.';
          passwordInput.setCustomValidity('Weak password.');
        } else {
          passwordInput.style.borderColor = '';
          passwordMessage.textContent = '';
          passwordInput.setCustomValidity('');
        }
      });

      // Confirm password validation
      confirmPasswordInput.addEventListener('input', () => {
        if (passwordInput.value !== confirmPasswordInput.value) {
          confirmPasswordInput.style.borderColor = 'red';
          confirmPasswordInput.setCustomValidity('Passwords do not match.');
        } else {
          confirmPasswordInput.style.borderColor = '';
          confirmPasswordInput.setCustomValidity('');
        }
      });

      // Full name validation
      fullnameInput.addEventListener('input', () => {
        if (!fullnameInput.value.match(/^[a-zA-Z\s]{2,20}$/)) {
          fullnameInput.style.borderColor = 'red';
          fullnameInput.setCustomValidity(
            'Full Name must contain only letters and spaces (2-20 characters).'
          );
        } else {
          fullnameInput.style.borderColor = '';
          fullnameInput.setCustomValidity('');
        }
      });

      // Title selection validation
      titleSelect.addEventListener('change', () => {
        if (!titleSelect.value) {
          titleSelect.style.borderColor = 'red';
          titleSelect.setCustomValidity('Please select a title.');
        } else {
          titleSelect.style.borderColor = '';
          titleSelect.setCustomValidity('');
        }
      });

      // Phone number validation
      phoneInput.addEventListener('input', () => {
        const phonePattern = /^[+]?[0-9]{10,14}$/;
        if (!phonePattern.test(phoneInput.value)) {
          phoneInput.style.borderColor = 'red';
          phoneInput.setCustomValidity('Please enter a valid phone number.');
        } else {
          phoneInput.style.borderColor = '';
          phoneInput.setCustomValidity('');
        }
      });

      // Nationality selection validation
      nationalitySelect.addEventListener('change', () => {
        if (!nationalitySelect.value) {
          nationalitySelect.style.borderColor = 'red';
          nationalitySelect.setCustomValidity(
            'Please select your nationality.'
          );
        } else {
          nationalitySelect.style.borderColor = '';
          nationalitySelect.setCustomValidity('');
        }
      });

      // Birthdate validation
      birthInput.addEventListener('input', () => {
        const today = new Date();
        const birthDate = new Date(birthInput.value);
        if (birthDate >= today) {
          birthInput.style.borderColor = 'red';
          birthInput.setCustomValidity('Birthdate must be in the past.');
        } else {
          birthInput.style.borderColor = '';
          birthInput.setCustomValidity('');
        }
      });

      // Prevent form submission if there are validation errors
      form.addEventListener('submit', (event) => {
        if (!form.checkValidity()) {
          event.preventDefault();
          alert('Please fill out all fields correctly before submitting.');
        }
      });
    });
  </script>

  <script type="module">
    import { fetchData, updateData } from '/js/http-calls.js';

    const SUCCESS_URL = 'Donor-confirmEdit.html';

    document.addEventListener('DOMContentLoaded', init);

    async function init() {
      const form = document.getElementById('edit-profile-form');
      const emailInput = document.getElementById('email');
      const passwordInput = document.getElementById('password');
      const confirmPasswordInput = document.getElementById('confirm-password');
      const nameInput = document.getElementById('full-name');
      const titleInput = document.getElementById('title');
      const roleSelect = document.getElementById('Role');
      const phoneInput = document.getElementById('phone');
      const dateOfBirthInput = document.getElementById('dob');
      const genderSelect = document.getElementById('gender');
      const regionSelect = document.getElementById('region');
      const nationalitySelect = document.getElementById('nationality');

      // fetch data
      const fetchResponse = await fetchData('/api/users/my-profile');
      if (!fetchResponse.isOk) {
        alert('Failed to fetch data');
        return;
      }

      // update the fields with the fetched data
      const user = fetchResponse.data.user;
      const donorAcquirerProfile = fetchResponse.data.donorAcquirerProfile;

      emailInput.value = user.email;
      nameInput.value = user.name;
      titleInput.value = user.title;
      roleSelect.value = donorAcquirerProfile.role;
      phoneInput.value = user.phoneNumber;
      dateOfBirthInput.value = new Date(user.dateOfBirth)
        .toISOString()
        .split('T')[0];
      genderSelect.value = user.gender;
      regionSelect.value = user.region;
      nationalitySelect.value = user.nationality;

      form.addEventListener('submit', async (event) => {
        event.preventDefault();

        const userDetails = {
          name: nameInput.value,
          email: emailInput.value,
          password: passwordInput.value,
          confirmPassword: confirmPasswordInput.value,
          gender: genderSelect.value,
          region: regionSelect.value,
          dateOfBirth: dateOfBirthInput.value,
          phoneNumber: phoneInput.value,
          title: titleInput.value,
          nationality: nationalitySelect.value,
        };

        const donorAcquirerDetails = {
          role: roleSelect.value,
        };

        const updateResponse = await updateData(
          '/api/users/my-profile/update',
          {
            userType: 'donorAcquirer',
            userDetails: userDetails,
            donorAcquirerDetails: donorAcquirerDetails,
          }
        );

        if (updateResponse.isOk) {
          window.location.href = SUCCESS_URL;
        } else {
          const errorDiv = document.createElement('div');
          errorDiv.classList.add('error');
          errorDiv.setAttribute('data-server-error', '');
          errorDiv.innerHTML = `${updateResponse.message.split('\n').join('<br>')}`;
          form.prepend(errorDiv);
          errorDiv.scrollIntoView({
            behavior: 'smooth',
            block: 'center',
          });
        }
      });
    }
  </script>
</html>
